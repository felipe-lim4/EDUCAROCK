<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="./assets/logo.svg" />
    <link rel="stylesheet" href="./css/style_inicial.css" />
    <!-- Carregar o Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Carregar o adaptador date-fns para o Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <title>Document</title>
  </head>
  <body>
    <header>
      <div class="navbar">
        <div class="logo">
          <a href="./index.html"><img src="./assets/logo.svg" alt="" /></a>
        </div>
        <ul class="navbar_options">
          <li>
            <a href="">Lendas</a>
          </li>
          <a href="./estudo.html">Estudo</a>
          <li>
            <a href="">Realizar Quiz</a>
          </li>
          <li>
            <a href="">Resultados Quiz</a>
          </li>
        </ul>
        <div id="bem_vindo">
          <p>Seja Bem vindo <br><span id="usuario">USUARIO!</span></p>
          
          <img src="" alt="" />
        </div>
      </div>
    </header>

    <section>
      <main class="main-container">
        <div class="main-cards">
          <div class="card" id="mediaDiaria">
            <h3>Media de estudo (Dia)</h3>
            <div class="card-inner">
              <h1 id="KPIMediaEstudo">?HORAS</h1>
            </div>
          </div>

          <!-- Tempo fora da condição ideal (Temperatura) -->
          <div class="card" id="mediaSemanal">
            <h3>Media de estudo (semanal)</h3>
            <div class="card-inner">
              <h1>?HORAS</h1>
            </div>
          </div>

          <!-- Umidade Atual -->
          <div class="card" id="mediaDiariaUsuarios">
            <h3>Media de estudo usuarios (dia)</h3>
            <div class="card-inner">
              <h1>?HORAS</h1>
            </div>
          </div>

          <!-- Tempo fora da condição ideal (Umidade) -->
          <div class="card">
            <h3>Media de estudo usuarios (semanal)</h3>
            <div class="card-inner" id="mediaSemanalUsuarios">
              <h1>?HORAS</h1>
            </div>
          </div>
        </div>

        <div class="charts">
          <div class="charts-card">
            <h2 class="chart-title">Horas Estudadas por Dia</h2>
            <div id="area-chart">
              <canvas id="graficoEstudo"></canvas>
            </div>
          </div>

          <div class="card-ranking">
            <div class="ranking-item">
              <p class="name">1. Artur Duarte</p>
              <p class="hours">50 horas</p>
            </div>
            <div class="ranking-item">
              <p class="name">2. Guilherme Roveri</p>
              <p class="hours">45 horas</p>
            </div>
            <div class="ranking-item">
              <p class="name">3. João Silva</p>
              <p class="hours">40 horas</p>
            </div>
            <div class="ranking-item">
              <p class="name">4. Murillo Reis</p>
              <p class="hours">35 horas</p>
            </div>
            <div class="ranking-item">
              <p class="name">5. Felipe Lima</p>
              <p class="hours">30 horas</p>
            </div>
          </div>
        </div>
      </main>
    </section>
  </body>
</html>

<script>

  window.onload = function () {
    buscarMedidasGrafico();
    buscarMedidasUsuarios();
  };


  function comparaDatas(data1, data2) {
  // Cria dois objetos Date, se já não forem objetos Date
  const date1 = new Date(data1);
  const date2 = new Date(data2);

  // Comparando as datas (ignora horas, minutos, segundos e milissegundos)
  return ((date1.toISOString().split('T')[0]) == date2.toISOString().split('T')[0]);
  }



  function buscarHorasEstudoUsuarios(){
    fetch(`/medidas/estudoUsuarios/`, { cache: "no-store" })

          .then(function (response) {
            if (response.ok) {
              response.json().then(function (resposta) {
                console.log(resposta)
              });
              
            } else {
              console.error("Nenhum dado encontrado ou erro na API");
            }
          })
          .catch(function (error) {
            console.error(
              `Erro na obtenção dos dados p/ gráfico: ${error.message}`
            );
          });

  }





  function geraGrafico(resposta) {
    var nomeUsuario = sessionStorage.USER_NAME
    usuario.innerHTML = nomeUsuario.toUpperCase() + '!'
    const data = {
      labels: [],
      datasets: [
        {
          label: `${nomeUsuario}`,
          data: [],
          fill: true,
          borderColor: "#06011B",
        },
        {
          label: "Usuarios",
          data: [],
          fill: true,
          borderColor: "#A90F0F",
        },
      ],
    };


    let dadosEstudos = resposta.reverse()
    

    //kpi

    var somaHoras = 0


    // insert de data de estudo
    const hoje = new Date();
    hoje.setDate(hoje.getDate() - 7);
    
    var indexEstudo = 0

    for (let i = 0; i < 7; i++) {

      var dataFormatada = hoje.toISOString();
      
      if(comparaDatas(dadosEstudos[indexEstudo].DataEstudo, dataFormatada ) && indexEstudo < dadosEstudos.length){

        data.labels.push(dadosEstudos[indexEstudo].DataEstudo)
        data.datasets[0].data.push(dadosEstudos[indexEstudo].qtdHora)
        somaHoras += dadosEstudos[indexEstudo].qtdHora
        indexEstudo++

      }else{

        data.labels.push(dataFormatada)
        data.datasets[0].data.push(0)
        
      }

      hoje.setDate(hoje.getDate() + 1)
    }
    

    var kpiMediaEstudo = somaHoras/7;
    KPIMediaEstudo.innerHTML = parseInt(kpiMediaEstudo) + ' Horas'


    const config = {
      type: "line",
      data: data,
      options: {
        responsive: true,
        scales: {
          x: {
            type: "time", // Escala baseada no tempo
            time: {
            unit: "day", // Ajustar unidade (dia, mês, hora, etc.)
            tooltipFormat: "MM dd, yyyy", // Formato do tooltip
            displayFormats: {
            day: "MM/dd", // Formato da exibição no eixo X
              },
            },
            grid: {
              color: "rgba(6, 1, 27, 0.5)", // Cor das linhas do grid no eixo X
            },
            border: {
              color: "rgba(6, 1, 27, 0.5)", // Cor da linha do eixo X
              width: 0.1, // Espessura da linha do eixo X
            },
          },

          y: {
            grid: {
              color: "rgba(6, 1, 27, 0.5)", // Cor das linhas do grid no eixo Y
            },
            border: {
              color: "rgba(6, 1, 27, 0.5)", // Cor da linha do eixo Y
              width:  0.1, // Espessura da linha do eixo Y
            },
          },
        },
      },
    };

    const graficoQtdEstudo = new Chart(
      document.getElementById("graficoEstudo"),
      config
    );
  }



  function buscarMedidasGrafico(){
    const idUsuario = sessionStorage.ID_USUARIO

    fetch(`/medidas//ultimas/${idUsuario}`, { cache: "no-store" })

          .then(function (response) {
            if (response.ok) {
              response.json().then(function (resposta) {
                console.log(resposta)
                geraGrafico(resposta)
              });
              
            } else {
              console.error("Nenhum dado encontrado ou erro na API");
            }
          })
          .catch(function (error) {
            console.error(
              `Erro na obtenção dos dados p/ gráfico: ${error.message}`
            );
          });
  }



</script>

